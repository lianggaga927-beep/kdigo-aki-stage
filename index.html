<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KDIGO AKI Calculator</title>
    <style>
        :root {
            --primary-color: #2563eb;
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --text-color: #1f2937;
            --border-radius: 12px;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            padding: 20px;
            line-height: 1.5;
            min-height: 100vh;
            box-sizing: border-box;
        }

        .container {
            background-color: var(--card-bg);
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            max-width: 480px;
            width: 100%;
            height: fit-content;
        }

        h1 {
            font-size: 1.5rem;
            margin: 0 0 0.5rem 0;
            text-align: center;
            color: var(--primary-color);
        }

        .subtitle {
            font-size: 0.85rem;
            text-align: center;
            color: #6b7280;
            margin-bottom: 1.5rem;
        }

        .section-title {
            font-size: 0.95rem;
            font-weight: 700;
            color: #374151;
            margin: 1.5rem 0 0.75rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #f3f4f6;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            color: #374151;
        }

        input[type="number"] {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 8px;
            font-size: 1rem;
            box-sizing: border-box;
            transition: border-color 0.2s;
        }

        input[type="number"]:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        .checkbox-container {
            background-color: #f9fafb;
            padding: 0.75rem;
            border-radius: 8px;
            border: 1px solid #e5e7eb;
            margin-bottom: 0.5rem;
        }

        .checkbox-group {
            display: flex;
            align-items: flex-start;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
            color: #4b5563;
        }
        
        .checkbox-group:last-child {
            margin-bottom: 0;
        }

        input[type="checkbox"] {
            margin-top: 0.25rem;
            margin-right: 0.5rem;
            cursor: pointer;
        }

        .toggle-btn {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            padding: 0;
            font-size: 0.9rem;
            font-weight: 600;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 4px;
            margin: 1rem 0;
        }
        
        .toggle-btn:hover {
            text-decoration: underline;
        }

        #uo-section {
            display: none;
            background-color: #eff6ff;
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
            border: 1px solid #bfdbfe;
            animation: fadeIn 0.3s ease-in-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(-5px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .uo-note {
            font-size: 0.8rem;
            color: #1e40af;
            margin-bottom: 1rem;
            background: rgba(255,255,255,0.5);
            padding: 0.5rem;
            border-radius: 4px;
        }

        .btn-row {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 1rem;
            margin-top: 2rem;
        }

        .btn-calc {
            background-color: var(--primary-color);
            color: white;
            padding: 0.85rem;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .btn-calc:hover {
            background-color: #1d4ed8;
        }

        .btn-reset {
            background-color: white;
            color: #4b5563;
            border: 1px solid #d1d5db;
            padding: 0.85rem;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .btn-reset:hover {
            background-color: #f3f4f6;
        }

        /* Result Section */
        .result-box {
            margin-top: 2rem;
            padding: 1.5rem;
            background-color: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: var(--border-radius);
            display: none;
            animation: slideUp 0.3s ease-out;
        }

        @keyframes slideUp {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .stage-badge {
            display: inline-block;
            padding: 0.35rem 1rem;
            border-radius: 9999px;
            font-weight: 700;
            color: white;
            font-size: 1.1rem;
            margin-bottom: 0.75rem;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .bg-green { background-color: #10b981; }
        .bg-yellow { background-color: #eab308; }
        .bg-orange { background-color: #f97316; }
        .bg-red { background-color: #ef4444; }

        .result-main {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1f2937;
            margin-bottom: 0.5rem;
        }

        .result-advice {
            font-size: 0.9rem;
            color: #4b5563;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
            border-bottom: 1px dashed #cbd5e1;
            line-height: 1.6;
        }

        .detail-text {
            font-size: 0.85rem;
            color: #64748b;
            line-height: 1.6;
        }

        .detail-item {
            margin-bottom: 0.4rem;
        }

        .unit {
            font-size: 0.85em;
            color: #9ca3af;
            font-weight: normal;
        }

        .disclaimer {
            margin-top: 2rem;
            font-size: 0.75rem;
            color: #9ca3af;
            text-align: center;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>KDIGO AKI Calculator</h1>
    <div class="subtitle">ä¾æ“š KDIGO 2012 è‡¨åºŠå¯¦è¸æŒ‡å¼•</div>

    <div class="section-title">1. è¡€æ¸…è‚Œé…¸é… (SCr)</div>
    <div class="form-group">
        <label>Baseline SCr <span class="unit">(mg/dL)</span></label>
        <input type="number" id="baseScr" step="0.01" placeholder="åŸºç¤å€¼ï¼Œä¾‹å¦‚: 0.8">
    </div>

    <div class="form-group">
        <label>Current SCr <span class="unit">(mg/dL)</span></label>
        <input type="number" id="currScr" step="0.01" placeholder="ç›®å‰å€¼ï¼Œä¾‹å¦‚: 1.3">
    </div>

    <div class="checkbox-container">
        <div class="checkbox-group">
            <input type="checkbox" id="is48h" checked>
            <label for="is48h">è®ŠåŒ–ç™¼ç”Ÿæ–¼ 48 å°æ™‚å…§ (Î” â‰¥ 0.3)</label>
        </div>
        <div class="checkbox-group">
            <input type="checkbox" id="is7d" checked>
            <label for="is7d">è®ŠåŒ–ç™¼ç”Ÿæ–¼ 7 å¤©å…§ (å€æ•¸ â‰¥ 1.5)</label>
        </div>
    </div>

    <div style="margin-top: 1rem; padding: 0.75rem; background-color: #fff1f2; border: 1px solid #fecdd3; border-radius: 8px;">
        <div class="checkbox-group" style="margin-bottom: 0;">
            <input type="checkbox" id="isRRT">
            <label for="isRRT" style="color: #be123c; font-weight: 700;">å·²å•Ÿå‹•è…è‡Ÿæ›¿ä»£æ²»ç™‚ (RRT)</label>
        </div>
    </div>

    <button class="toggle-btn" onclick="toggleUO()">
        <span id="uo-icon">â•</span> åŠ å…¥å°¿é‡ (Urine Output) èˆ‡é«”é‡è©•ä¼°
    </button>

    <div id="uo-section">
        <div class="uo-note">
            ğŸ’¡ å»ºè­°è¼¸å…¥ 6, 12 æˆ– 24 å°æ™‚ä¹‹ç¸½å°¿é‡ã€‚
        </div>
        <div class="form-group">
            <label>é«”é‡ Weight <span class="unit">(kg)</span></label>
            <input type="number" id="weight" step="0.1" placeholder="ä¾‹å¦‚: 60">
        </div>
        <div class="form-group">
            <label>ç¸½å°¿é‡ Total Volume <span class="unit">(mL)</span></label>
            <input type="number" id="urineVol" placeholder="ä¾‹å¦‚: 200">
        </div>
        <div class="form-group">
            <label>æ”¶é›†æ™‚é–“ Duration <span class="unit">(hours)</span></label>
            <input type="number" id="urineTime" placeholder="ä¾‹å¦‚: 6">
        </div>
        <div id="uo-rate-display" style="font-weight: 600; color: var(--primary-color); font-size: 0.9rem;"></div>
    </div>

    <div class="btn-row">
        <button class="btn-calc" onclick="calculateAKI()">è¨ˆç®— AKI åˆ†ç´š</button>
        <button class="btn-reset" onclick="resetForm()">æ¸…é™¤é‡å¡«</button>
    </div>

    <div id="result" class="result-box">
        <div id="stageBadge" class="stage-badge"></div>
        <div id="resultText" class="result-main"></div>
        <div id="adviceText" class="result-advice"></div>
        <div style="font-size: 0.8rem; font-weight: 700; color: #475569; margin-bottom: 0.5rem;">åˆ¤å®šç´°ç¯€ï¼š</div>
        <div id="reasonText" class="detail-text"></div>
    </div>

    <div class="disclaimer">
        å…è²¬è²æ˜ï¼šæœ¬å·¥å…·åƒ…ä¾›é†«ç™‚å°ˆæ¥­äººå“¡æ•™è‚²èˆ‡è¼”åŠ©åƒè€ƒï¼Œä¸å¯å–ä»£è‡¨åºŠå°ˆæ¥­åˆ¤æ–·ã€‚
        å°å…’æ—ç¾¤ (Age < 18) ä¹‹ eGFR æ¨™æº–æœªç´å…¥æœ¬è¨ˆç®—å™¨ã€‚
    </div>
</div>

<script>
    function toggleUO() {
        const section = document.getElementById('uo-section');
        const btnText = document.querySelector('.toggle-btn');
        const icon = document.getElementById('uo-icon');
        
        if (section.style.display === 'block') {
            section.style.display = 'none';
            btnText.innerHTML = '<span id="uo-icon">â•</span> åŠ å…¥å°¿é‡ (Urine Output) èˆ‡é«”é‡è©•ä¼°';
        } else {
            section.style.display = 'block';
            btnText.innerHTML = '<span id="uo-icon">â–</span> æ”¶èµ·å°¿é‡è©•ä¼°';
        }
    }

    function resetForm() {
        // Inputs
        document.getElementById('baseScr').value = '';
        document.getElementById('currScr').value = '';
        document.getElementById('is48h').checked = true;
        document.getElementById('is7d').checked = true;
        document.getElementById('isRRT').checked = false;
        
        document.getElementById('weight').value = '';
        document.getElementById('urineVol').value = '';
        document.getElementById('urineTime').value = '';
        document.getElementById('uo-rate-display').innerText = '';

        // Results
        document.getElementById('result').style.display = 'none';
    }

    function calculateAKI() {
        const resultDiv = document.getElementById('result');
        const badge = document.getElementById('stageBadge');
        const resultText = document.getElementById('resultText');
        const adviceText = document.getElementById('adviceText');
        const reasonText = document.getElementById('reasonText');
        const uoRateDiv = document.getElementById('uo-rate-display');

        // Clear previous results
        reasonText.innerHTML = '';
        adviceText.innerText = '';
        uoRateDiv.innerText = '';
        let reasons = [];

        // 1. å„ªå…ˆåˆ¤å®š RRT (Priority Check)
        const isRRT = document.getElementById('isRRT').checked;
        if (isRRT) {
            resultDiv.style.display = 'block';
            badge.className = 'stage-badge bg-red';
            badge.innerText = 'AKI Stage 3';
            resultText.innerText = 'å·²å•Ÿå‹•è…è‡Ÿæ›¿ä»£æ²»ç™‚ (RRT)';
            adviceText.innerText = 'ç—…äººå·²æ¥å—é€ææ²»ç™‚ï¼Œä¾æ“š KDIGO å®šç¾©ç›´æ¥æ­¸é¡ç‚º Stage 3ã€‚';
            reasonText.innerHTML = '<div class="detail-item">ğŸ”´ <strong>RRT:</strong> ä½¿ç”¨è€…å‹¾é¸å·²å•Ÿå‹•æ²»ç™‚ã€‚</div>';
            return; // çµæŸå‡½å¼
        }

        // 2. å–å¾—ä¸¦è™•ç†è¼¸å…¥å€¼
        const baseScrVal = document.getElementById('baseScr').value;
        const currScrVal = document.getElementById('currScr').value;
        const baseScr = parseFloat(baseScrVal);
        const currScr = parseFloat(currScrVal);
        
        const weight = parseFloat(document.getElementById('weight').value);
        const uVol = parseFloat(document.getElementById('urineVol').value);
        const uTime = parseFloat(document.getElementById('urineTime').value);

        const is48h = document.getElementById('is48h').checked;
        const is7d = document.getElementById('is7d').checked;

        // 3. æª¢æŸ¥æ˜¯å¦æœ‰è¶³å¤ è³‡æ–™é€²è¡Œè¨ˆç®—
        const hasScrInput = !isNaN(baseScr) && !isNaN(currScr);
        const hasUOInput = !isNaN(weight) && !isNaN(uVol) && !isNaN(uTime);

        if (!hasScrInput && !hasUOInput) {
            alert('è«‹è¼¸å…¥å®Œæ•´ SCr æ•¸å€¼ï¼Œæˆ–è¼¸å…¥å®Œæ•´å°¿é‡è³‡æ–™ä»¥é€²è¡Œè¨ˆç®—ã€‚');
            return;
        }

        let scrStage = 0;
        let uoStage = 0;

        // --- SCr è¨ˆç®—é‚è¼¯ ---
        if (hasScrInput) {
            if (baseScr <= 0 || currScr <= 0) {
                alert('SCr æ•¸å€¼å¿…é ˆå¤§æ–¼ 0'); return;
            }

            const ratio = currScr / baseScr;
            const increase = currScr - baseScr;
            const scrInfo = `Base: ${baseScr} â†’ Curr: ${currScr} (x${ratio.toFixed(2)})`;

            if (increase <= 0) {
                scrStage = 0;
                reasons.push(`<div class="detail-item">ğŸŸ¢ <strong>SCr:</strong> æœªä¸Šå‡ (${scrInfo})</div>`);
            } else {
                // æª¢æŸ¥æ˜¯å¦ç¬¦åˆ AKI æ™‚é–“çª—å‰æ
                if (!is48h && !is7d) {
                     reasons.push(`<div class="detail-item">âšª <strong>SCr:</strong> æ•¸å€¼ä¸Šå‡ä½†æœªç¬¦åˆæ™‚é–“çª— (No AKI)</div>`);
                } else {
                    // Stage 3 åˆ¤å®š: 
                    // 1. 3å€ baseline (7å¤©å…§)
                    // 2. SCr >= 4.0 ä¸”æ€¥å‡ >= 0.3 (ä¸ç®¡å¹¾å€ï¼Œåªè¦åœ¨AKIæ™‚é–“çª—å…§ç™¼ç”Ÿ)
                    if ( (ratio >= 3.0 && is7d) || 
                         (currScr >= 4.0 && increase >= 0.3 && (is48h || is7d)) ) {
                        scrStage = 3;
                    }
                    // Stage 2: 2.0-2.9å€
                    else if (ratio >= 2.0 && is7d) {
                        scrStage = 2;
                    }
                    // Stage 1: 1.5-1.9å€ OR å¢åŠ  >= 0.3 (48hå…§)
                    else if ( (ratio >= 1.5 && is7d) || (increase >= 0.3 && is48h) ) {
                        scrStage = 1;
                    }

                    const colorIcon = scrStage === 3 ? 'ğŸ”´' : (scrStage === 2 ? 'ğŸŸ ' : (scrStage === 1 ? 'ğŸŸ¡' : 'ğŸŸ¢'));
                    const stageText = scrStage > 0 ? `Stage ${scrStage}` : 'No AKI';
                    reasons.push(`<div class="detail-item">${colorIcon} <strong>SCr:</strong> ${stageText} <span style="color:#888; font-size:0.8em">(${scrInfo})</span></div>`);
                }
            }
        }

        // --- UO è¨ˆç®—é‚è¼¯ ---
        if (hasUOInput) {
            if (weight <= 0 || uTime <= 0 || uVol < 0) {
                alert('é«”é‡èˆ‡æ™‚é–“å¿…é ˆå¤§æ–¼ 0ï¼Œå°¿é‡ä¸å¯ç‚ºè² å€¼'); return;
            }
            
            const uoRate = uVol / weight / uTime;
            uoRateDiv.innerText = `ç›®å‰å°¿é‡é€Ÿç‡: ${uoRate.toFixed(2)} mL/kg/h`;

            // Stage 3: <0.3 (24h) OR Anuria (12h). é€™è£¡ Anuria æ”¾å¯¬ç‚º < 10mL ä»¥å®¹è¨±æ®˜é¤˜å°¿
            if ( (uoRate < 0.3 && uTime >= 24) || (uVol < 10 && uTime >= 12) ) {
                uoStage = 3;
            }
            // Stage 2: <0.5 (12h)
            else if (uoRate < 0.5 && uTime >= 12) {
                uoStage = 2;
            }
            // Stage 1: <0.5 (6h)
            else if (uoRate < 0.5 && uTime >= 6) {
                uoStage = 1;
            }

            const colorIcon = uoStage === 3 ? 'ğŸ”´' : (uoStage === 2 ? 'ğŸŸ ' : (uoStage === 1 ? 'ğŸŸ¡' : 'ğŸŸ¢'));
            const stageText = uoStage > 0 ? `Stage ${uoStage}` : 'No AKI';
            reasons.push(`<div class="detail-item">${colorIcon} <strong>UO:</strong> ${stageText} <span style="color:#888; font-size:0.8em">(${uoRate.toFixed(2)} mL/kg/h for ${uTime}h)</span></div>`);
        }

        // 4. ç¶œåˆåˆ¤å®š (å–æœ€å¤§å€¼)
        const finalStage = Math.max(scrStage, uoStage);

        resultDiv.style.display = 'block';
        reasonText.innerHTML = reasons.join('');

        if (finalStage === 0) {
            badge.className = 'stage-badge bg-green';
            badge.innerText = 'No AKI';
            resultText.innerText = 'æœªé”åˆ° KDIGO AKI å®šç¾©æ¨™æº–';
            adviceText.innerText = 'å»ºè­°æŒçºŒç›£æ¸¬è…åŠŸèƒ½èˆ‡å°¿é‡ã€‚è‹¥è‡¨åºŠæ‡·ç–‘ï¼Œè«‹ç¢ºèªæ˜¯å¦ç¬¦åˆæ™‚é–“çª—å®šç¾© (48h/7d)ã€‚';
        } else {
            if (finalStage === 1) badge.className = 'stage-badge bg-yellow';
            if (finalStage === 2) badge.className = 'stage-badge bg-orange';
            if (finalStage === 3) badge.className = 'stage-badge bg-red';
            
            badge.innerText = `AKI Stage ${finalStage}`;
            resultText.innerText = 'ç¬¦åˆ KDIGO æ€¥æ€§è…æå‚·å®šç¾©';
            
            if (finalStage === 1) {
                adviceText.innerText = 'å»ºè­°è©•ä¼°é«”æ¶²ç‹€æ…‹ï¼Œæ’é™¤é˜»å¡ï¼Œåœç”¨è…æ¯’æ€§è—¥ç‰©ï¼Œå¯†åˆ‡ç›£æ¸¬ SCr èˆ‡å°¿é‡ã€‚';
            } else if (finalStage === 2) {
                adviceText.innerText = 'å»ºè­°èª¿æ•´è—¥ç‰©åŠ‘é‡ï¼Œè©•ä¼°æ˜¯å¦éœ€è¦é€²ä¸€æ­¥çš„æ¶²é«”ç®¡ç†æˆ–åˆ©å°¿åŠ‘æ¸¬è©¦ï¼Œè€ƒæ…®æœƒè¨ºè…è‡Ÿç§‘ã€‚';
            } else if (finalStage === 3) {
                adviceText.innerText = 'ç—…æƒ…å±æ€¥ã€‚å»ºè­°ç«‹å³è©•ä¼°ä½µç™¼ç—‡ (é«˜è¡€é‰€ã€é…¸ä¸­æ¯’ã€é«”æ¶²éå¤š)ï¼Œè€ƒæ…®é€ææ²»ç™‚ (RRT) ä¹‹é©æ‡‰ç—‡ã€‚';
            }
        }
    }
</script>

</body>
</html>
