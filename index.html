<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KDIGO AKI Calculator</title>
    <style>
        :root {
            --primary-color: #2563eb;
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --text-color: #1f2937;
            --border-radius: 8px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            padding: 20px;
            line-height: 1.5;
        }

        .container {
            background-color: var(--card-bg);
            padding: 2rem;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            width: 100%;
        }

        h1 {
            font-size: 1.5rem;
            margin-bottom: 1.5rem;
            text-align: center;
            color: var(--primary-color);
            border-bottom: 2px solid #e5e7eb;
            padding-bottom: 10px;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.5rem;
            font-size: 0.9rem;
        }

        input[type="number"] {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: var(--border-radius);
            font-size: 1rem;
            box-sizing: border-box; /* Fix padding issue */
        }

        input[type="checkbox"] {
            margin-right: 0.5rem;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            margin-top: 0.5rem;
            font-size: 0.9rem;
            color: #4b5563;
        }

        .toggle-btn {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            padding: 0;
            font-size: 0.9rem;
            text-decoration: underline;
            margin-bottom: 1rem;
            display: inline-block;
        }

        #uo-section {
            display: none; /* Hidden by default */
            background-color: #eff6ff;
            padding: 1rem;
            border-radius: var(--border-radius);
            margin-bottom: 1rem;
            border: 1px solid #bfdbfe;
        }

        .btn-calc {
            width: 100%;
            background-color: var(--primary-color);
            color: white;
            padding: 0.75rem;
            border: none;
            border-radius: var(--border-radius);
            font-size: 1rem;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.2s;
        }

        .btn-calc:hover {
            background-color: #1d4ed8;
        }

        .result-box {
            margin-top: 1.5rem;
            padding: 1rem;
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: var(--border-radius);
            display: none;
        }

        .stage-badge {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            border-radius: 9999px;
            font-weight: bold;
            color: white;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
        }

        .bg-green { background-color: #10b981; }
        .bg-yellow { background-color: #f59e0b; }
        .bg-orange { background-color: #f97316; }
        .bg-red { background-color: #ef4444; }

        .detail-text {
            font-size: 0.85rem;
            color: #6b7280;
            margin-top: 5px;
        }
        
        .unit {
            font-size: 0.8em;
            color: #888;
            font-weight: normal;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>KDIGO AKI Calculator</h1>

    <div class="form-group">
        <label>Baseline SCr <span class="unit">(mg/dL)</span></label>
        <input type="number" id="baseScr" step="0.01" placeholder="例如: 0.8">
    </div>

    <div class="form-group">
        <label>Current SCr <span class="unit">(mg/dL)</span></label>
        <input type="number" id="currScr" step="0.01" placeholder="例如: 1.3">
        
        <div class="checkbox-group">
            <input type="checkbox" id="is48h" checked>
            <label for="is48h" style="margin-bottom:0; font-weight:normal;">數值變化在 48 小時內?</label>
        </div>
    </div>

    <button class="toggle-btn" onclick="toggleUO()">+ 加入尿量 (Urine Output) 與體重評估</button>

    <div id="uo-section">
        <div class="form-group">
            <label>體重 Weight <span class="unit">(kg)</span></label>
            <input type="number" id="weight" step="0.1" placeholder="例如: 60">
        </div>
        <div class="form-group">
            <label>尿量 Urine Volume <span class="unit">(Total mL)</span></label>
            <input type="number" id="urineVol" placeholder="例如: 200">
        </div>
        <div class="form-group">
            <label>收集時間 Duration <span class="unit">(Hours)</span></label>
            <input type="number" id="urineTime" placeholder="例如: 6">
        </div>
        <div id="uo-rate-display" class="detail-text" style="font-weight:bold; color:var(--primary-color);"></div>
    </div>

    <button class="btn-calc" onclick="calculateAKI()">計算 AKI Stage</button>

    <div id="result" class="result-box">
        <div id="stageBadge" class="stage-badge"></div>
        <div id="resultText" style="font-weight: 500;"></div>
        <div id="reasonText" class="detail-text"></div>
    </div>
</div>

<script>
    function toggleUO() {
        const section = document.getElementById('uo-section');
        const btn = document.querySelector('.toggle-btn');
        if (section.style.display === 'block') {
            section.style.display = 'none';
            btn.textContent = '+ 加入尿量 (Urine Output) 與體重評估';
        } else {
            section.style.display = 'block';
            btn.textContent = '- 收起尿量評估';
        }
    }

    function calculateAKI() {
        // Get Values
        const baseScr = parseFloat(document.getElementById('baseScr').value);
        const currScr = parseFloat(document.getElementById('currScr').value);
        const is48h = document.getElementById('is48h').checked;
        
        const weight = parseFloat(document.getElementById('weight').value);
        const uVol = parseFloat(document.getElementById('urineVol').value);
        const uTime = parseFloat(document.getElementById('urineTime').value);

        let scrStage = 0;
        let uoStage = 0;
        let reasons = [];

        // 1. Calculate SCr Stage
        if (!isNaN(baseScr) && !isNaN(currScr)) {
            const ratio = currScr / baseScr;
            const increase = currScr - baseScr;

            // Stage 3 Logic
            if (ratio >= 3.0 || currScr >= 4.0) { 
                // Note: strict KDIGO for >=4.0 also requires acute rise of >=0.3, 
                // simplified here as per common calculator logic, but technically requires check.
                scrStage = 3;
            } 
            // Stage 2 Logic
            else if (ratio >= 2.0) {
                scrStage = 2;
            } 
            // Stage 1 Logic
            else if (ratio >= 1.5 || (increase >= 0.3 && is48h)) {
                scrStage = 1;
            }
            
            if(scrStage > 0) reasons.push(`SCr: ${currScr} (Baseline ${baseScr}) -> Stage ${scrStage}`);
        }

        // 2. Calculate UO Stage (if data exists)
        if (!isNaN(weight) && !isNaN(uVol) && !isNaN(uTime) && weight > 0 && uTime > 0) {
            const uoRate = uVol / weight / uTime; // mL/kg/h
            document.getElementById('uo-rate-display').innerText = `目前尿量速率: ${uoRate.toFixed(2)} mL/kg/h`;

            // Stage 3: <0.3 for >=24h OR Anuria for >=12h (Anuria logic relies on Vol=0)
            if ((uoRate < 0.3 && uTime >= 24) || (uVol === 0 && uTime >= 12)) {
                uoStage = 3;
            }
            // Stage 2: <0.5 for >=12h
            else if (uoRate < 0.5 && uTime >= 12) {
                uoStage = 2;
            }
            // Stage 1: <0.5 for >=6h
            else if (uoRate < 0.5 && uTime >= 6) {
                uoStage = 1;
            }

            if(uoStage > 0) reasons.push(`UO Rate: ${uoRate.toFixed(2)} mL/kg/h (${uTime}hrs) -> Stage ${uoStage}`);
        } else {
            document.getElementById('uo-rate-display').innerText = "";
        }

        // 3. Determine Final Stage
        const finalStage = Math.max(scrStage, uoStage);
        
        // Display Results
        const resultDiv = document.getElementById('result');
        const badge = document.getElementById('stageBadge');
        const resultText = document.getElementById('resultText');
        const reasonText = document.getElementById('reasonText');

        resultDiv.style.display = 'block';

        if (finalStage === 0) {
            badge.className = 'stage-badge bg-green';
            badge.innerText = 'No AKI';
            resultText.innerText = '未達到 AKI 定義標準';
            reasonText.innerText = 'Creatinine 與尿量皆在正常變化範圍內。';
        } else {
            if (finalStage === 1) badge.className = 'stage-badge bg-yellow';
            if (finalStage === 2) badge.className = 'stage-badge bg-orange';
            if (finalStage === 3) badge.className = 'stage-badge bg-red';
            
            badge.innerText = `AKI Stage ${finalStage}`;
            resultText.innerText = `根據 KDIGO 準則判定`;
            reasonText.innerHTML = reasons.join('<br>');
        }
    }
</script>

</body>
</html>