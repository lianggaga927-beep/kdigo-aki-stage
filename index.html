<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>KDIGO AKI Calculator</title>
    <style>
        :root {
            --primary-color: #2563eb;
            --bg-color: #f3f4f6;
            --card-bg: #ffffff;
            --text-color: #1f2937;
            --border-radius: 8px;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            display: flex;
            justify-content: center;
            padding: 20px;
            line-height: 1.5;
        }

        .container {
            background-color: var(--card-bg);
            padding: 1.75rem;
            border-radius: var(--border-radius);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            max-width: 420px;
            width: 100%;
        }

        h1 {
            font-size: 1.4rem;
            margin-bottom: 0.5rem;
            text-align: center;
            color: var(--primary-color);
        }

        .subtitle {
            font-size: 0.8rem;
            text-align: center;
            color: #6b7280;
            margin-bottom: 1.25rem;
        }

        .section-title {
            font-size: 0.9rem;
            font-weight: 600;
            margin: 1rem 0 0.5rem;
            border-bottom: 1px solid #e5e7eb;
            padding-bottom: 0.25rem;
        }

        .form-group {
            margin-bottom: 0.85rem;
        }

        label {
            display: block;
            font-weight: 600;
            margin-bottom: 0.35rem;
            font-size: 0.9rem;
        }

        input[type="number"] {
            width: 100%;
            padding: 0.55rem 0.7rem;
            border: 1px solid #d1d5db;
            border-radius: var(--border-radius);
            font-size: 0.95rem;
            box-sizing: border-box;
        }

        input[type="checkbox"] {
            margin-right: 0.35rem;
        }

        .checkbox-row {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            flex-wrap: wrap;
            margin-top: 0.25rem;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            font-size: 0.8rem;
            color: #4b5563;
        }

        .toggle-btn {
            background: none;
            border: none;
            color: var(--primary-color);
            cursor: pointer;
            padding: 0;
            font-size: 0.85rem;
            text-decoration: underline;
            margin: 0.5rem 0 0.75rem;
            display: inline-block;
        }

        #uo-section {
            display: none;
            background-color: #eff6ff;
            padding: 0.85rem;
            border-radius: var(--border-radius);
            margin-bottom: 0.75rem;
            border: 1px solid #bfdbfe;
        }

        .uo-note {
            font-size: 0.78rem;
            color: #4b5563;
            margin-bottom: 0.5rem;
        }

        .btn-row {
            display: flex;
            gap: 0.75rem;
            margin-top: 0.75rem;
        }

        .btn-calc, .btn-reset {
            flex: 1;
            padding: 0.65rem;
            border-radius: var(--border-radius);
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            border: none;
            transition: background-color 0.15s, border-color 0.15s, color 0.15s;
        }

        .btn-calc {
            background-color: var(--primary-color);
            color: white;
        }

        .btn-calc:hover {
            background-color: #1d4ed8;
        }

        .btn-reset {
            background-color: #ffffff;
            color: #4b5563;
            border: 1px solid #d1d5db;
        }

        .btn-reset:hover {
            background-color: #f3f4f6;
        }

        .result-box {
            margin-top: 1.25rem;
            padding: 0.9rem;
            background-color: #f9fafb;
            border: 1px solid #e5e7eb;
            border-radius: var(--border-radius);
            display: none;
        }

        .stage-badge {
            display: inline-block;
            padding: 0.25rem 0.7rem;
            border-radius: 9999px;
            font-weight: 700;
            color: white;
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }

        .bg-green { background-color: #10b981; }
        .bg-yellow { background-color: #eab308; }
        .bg-orange { background-color: #f97316; }
        .bg-red { background-color: #ef4444; }

        .result-main {
            font-size: 0.9rem;
            font-weight: 500;
            margin-bottom: 0.35rem;
        }

        .result-advice {
            font-size: 0.8rem;
            color: #4b5563;
            margin-bottom: 0.25rem;
        }

        .detail-text {
            font-size: 0.78rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }

        .detail-text strong {
            color: #374151;
        }

        .uo-rate {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--primary-color);
            margin-top: 0.35rem;
        }

        .unit {
            font-size: 0.8em;
            color: #888;
            font-weight: normal;
        }

        .disclaimer {
            margin-top: 0.75rem;
            font-size: 0.72rem;
            color: #9ca3af;
            border-top: 1px dashed #e5e7eb;
            padding-top: 0.5rem;
        }

        .note-warning {
            font-size: 0.75rem;
            color: #b45309;
            margin-top: 0.25rem;
        }
    </style>
</head>
<body>

<div class="container">
    <h1>KDIGO AKI Calculator</h1>
    <div class="subtitle">依 KDIGO 2012 準則，僅供成人教育與輔助評估使用</div>

    <div class="section-title">1. Serum Creatinine (SCr)</div>
    <div class="form-group">
        <label>Baseline SCr <span class="unit">(mg/dL)</span></label>
        <input type="number" id="baseScr" step="0.01" placeholder="例如: 0.8">
    </div>

    <div class="form-group">
        <label>Current SCr <span class="unit">(mg/dL)</span></label>
        <input type="number" id="currScr" step="0.01" placeholder="例如: 1.3">
    </div>

    <div class="checkbox-row">
        <div class="checkbox-group">
            <input type="checkbox" id="is48h" checked>
            <label for="is48h" style="margin-bottom:0; font-weight:normal;">
                ΔSCr 變化發生於 48 小時內 (≥0.3 mg/dL)
            </label>
        </div>
        <div class="checkbox-group">
            <input type="checkbox" id="is7d" checked>
            <label for="is7d" style="margin-bottom:0; font-weight:normal;">
                SCr 倍數變化發生於 7 天內 (≥1.5 倍)
            </label>
        </div>
    </div>

    <div class="checkbox-group" style="margin-top:0.4rem;">
        <input type="checkbox" id="isRRT">
        <label for="isRRT" style="margin-bottom:0; font-weight:normal;">
            已啟動腎臟替代治療 (RRT)？
        </label>
    </div>

    <button class="toggle-btn" onclick="toggleUO()">+ 加入尿量 (Urine Output) 與體重評估</button>

    <div id="uo-section">
        <div class="uo-note">
            建議使用近 6–24 小時之總尿量，例如 6、12 或 24 小時收集。
        </div>
        <div class="form-group">
            <label>體重 Weight <span class="unit">(kg)</span></label>
            <input type="number" id="weight" step="0.1" placeholder="例如: 60">
        </div>
        <div class="form-group">
            <label>總尿量 Urine Volume <span class="unit">(mL)</span></label>
            <input type="number" id="urineVol" placeholder="例如: 200">
        </div>
        <div class="form-group">
            <label>收集時間 Duration <span class="unit">(hours)</span></label>
            <input type="number" id="urineTime" placeholder="例如: 6">
        </div>
        <div id="uo-rate-display" class="uo-rate"></div>
    </div>

    <div class="btn-row">
        <button class="btn-calc" onclick="calculateAKI()">計算 AKI Stage</button>
        <button class="btn-reset" onclick="resetForm()">清除重填</button>
    </div>

    <div id="result" class="result-box">
        <div id="stageBadge" class="stage-badge"></div>
        <div id="resultText" class="result-main"></div>
        <div id="adviceText" class="result-advice"></div>
        <div id="reasonText" class="detail-text"></div>
        <div id="noteText" class="note-warning"></div>
    </div>

    <div class="disclaimer">
        本工具僅供教學與輔助評估使用，並假設為成人患者。
        實際診斷與處置需由臨床醫師綜合病情判斷，
        小兒 eGFR 規則未納入計算。
    </div>
</div>

<script>
    function toggleUO() {
        const section = document.getElementById('uo-section');
        const btn = document.querySelector('.toggle-btn');
        if (section.style.display === 'block') {
            section.style.display = 'none';
            btn.textContent = '+ 加入尿量 (Urine Output) 與體重評估';
        } else {
            section.style.display = 'block';
            btn.textContent = '- 收起尿量評估';
        }
    }

    function resetForm() {
        document.getElementById('baseScr').value = '';
        document.getElementById('currScr').value = '';
        document.getElementById('is48h').checked = true;
        document.getElementById('is7d').checked = true;
        document.getElementById('isRRT').checked = false;

        document.getElementById('weight').value = '';
        document.getElementById('urineVol').value = '';
        document.getElementById('urineTime').value = '';
        document.getElementById('uo-rate-display').innerText = '';

        document.getElementById('result').style.display = 'none';
        document.getElementById('noteText').innerText = '';
    }

    function calculateAKI() {
        const baseScrVal = document.getElementById('baseScr').value;
        const currScrVal = document.getElementById('currScr').value;

        const baseScr = parseFloat(baseScrVal);
        const currScr = parseFloat(currScrVal);
        const is48h = document.getElementById('is48h').checked;
        const is7d = document.getElementById('is7d').checked;
        const isRRT = document.getElementById('isRRT').checked;

        const weightVal = document.getElementById('weight').value;
        const uVolVal = document.getElementById('urineVol').value;
        const uTimeVal = document.getElementById('urineTime').value;

        const weight = parseFloat(weightVal);
        const uVol = parseFloat(uVolVal);
        const uTime = parseFloat(uTimeVal);

        const resultDiv = document.getElementById('result');
        const badge = document.getElementById('stageBadge');
        const resultText = document.getElementById('resultText');
        const adviceText = document.getElementById('adviceText');
        const reasonText = document.getElementById('reasonText');
        const noteText = document.getElementById('noteText');
        const uoRateDiv = document.getElementById('uo-rate-display');

        reasonText.innerHTML = '';
        adviceText.innerText = '';
        noteText.innerText = '';
        uoRateDiv.innerText = '';

        // ===== 防呆：SCr 輸入檢查 =====
        if (isNaN(baseScr) || isNaN(currScr)) {
            alert('請輸入 Baseline 與 Current SCr 數值。');
            return;
        }
        if (baseScr <= 0 || currScr <= 0) {
            alert('SCr 數值需大於 0。');
            return;
        }

        let scrStage = 0;
        let uoStage = 0;
        let reasons = [];

        const ratio = currScr / baseScr;
        const increase = currScr - baseScr;

        // ===== SCr 詳細說明 =====
        let scrDetail = `SCr 比值: ${ratio.toFixed(2)} 倍 (${baseScr.toFixed(2)} → ${currScr.toFixed(2)} mg/dL)，ΔSCr: ${increase >= 0 ? '+' : ''}${increase.toFixed(2)} mg/dL`;
        let scrReasonStage = '';

        // ===== SCr Stage 判定 =====
        if (increase <= 0) {
            scrStage = 0;
            scrReasonStage = '目前 SCr 未高於基準值，未以 SCr 判定 AKI。';
        } else {
            // Stage 3: 倍數 ≥3 或 SCr ≥4 且急性上升 ≥0.3
            if ((ratio >= 3.0 && is7d) ||
                (currScr >= 4.0 && increase >= 0.3 && is48h)) {
                scrStage = 3;
                scrReasonStage = 'SCr 滿足 Stage 3 條件 (倍數 ≥3 或 ≥4 mg/dL 且急性上升)。';
            }
            // Stage 2: 倍數 2.0–2.9，假設在 7 天內
            else if (ratio >= 2.0 && is7d) {
                scrStage = 2;
                scrReasonStage = 'SCr 滿足 Stage 2 條件 (2.0–2.9 倍 baseline，於 7 天內)。';
            }
            // Stage 1: 倍數 1.5–1.9 (7 天內) 或 ΔSCr ≥0.3 (48 小時內)
            else {
                let isStage1 = false;
                if (ratio >= 1.5 && is7d) {
                    scrStage = 1;
                    isStage1 = true;
                    scrReasonStage = 'SCr 滿足 Stage 1 條件 (1.5–1.9 倍 baseline，於 7 天內)。';
                }
                if (increase >= 0.3 && is48h) {
                    // 確保至少 Stage 1
                    scrStage = Math.max(scrStage, 1);
                    if (!isStage1) {
                        scrReasonStage = 'SCr 滿足 Stage 1 條件 (48 小時內上升 ≥0.3 mg/dL)。';
                    } else {
                        scrReasonStage += ' 且 48 小時內 ΔSCr ≥0.3 mg/dL。';
                    }
                }
                if (scrStage === 0) {
                    scrReasonStage = 'SCr 變化尚未滿足 KDIGO AKI 定義。';
                }
            }
        }

        reasons.push(`<strong>SCr 分級：</strong>${scrStage === 0 ? 'No AKI by SCr' : 'Stage ' + scrStage}。`);
        reasons.push(scrDetail);
        reasons.push(scrReasonStage);

        // ===== 尿量輸入檢查 =====
        const hasAnyUOInput = (weightVal !== '' || uVolVal !== '' || uTimeVal !== '');
        let usedUO = false;

        if (hasAnyUOInput) {
            if (isNaN(weight) || isNaN(uVol) || isNaN(uTime) ||
                weight <= 0 || uTime <= 0 || uVol < 0) {
                alert('請確認體重、總尿量與收集時間皆已正確填寫且為合理數值。');
                return;
            }

            const uoRate = uVol / weight / uTime; // mL/kg/h
            usedUO = true;
            uoRateDiv.innerText = `目前尿量速率: ${uoRate.toFixed(2)} mL/kg/h，觀察時間 ${uTime.toFixed(1)} 小時`;

            // Stage 3: <0.3 for >=24h 或 無尿 ≥12h
            if ((uoRate < 0.3 && uTime >= 24) || (uVol === 0 && uTime >= 12)) {
                uoStage = 3;
            }
            // Stage 2: <0.5 for >=12h
            else if (uoRate < 0.5 && uTime >= 12) {
                uoStage = 2;
            }
            // Stage 1: <0.5 for >=6h
            else if (uoRate < 0.5 && uTime >= 6) {
                uoStage = 1;
            } else {
                uoStage = 0;
            }

            reasons.push(
                `<strong>尿量分級：</strong>${uoStage === 0 ? '未達 AKI 門檻' : 'Stage ' + uoStage}。` +
                ` (UO Rate ${uoRate.toFixed(2)} mL/kg/h，${uTime.toFixed(1)} 小時)`
            );
        } else {
            reasons.push('<strong>尿量分級：</strong>未輸入尿量，僅依 SCr 判定 AKI。');
        }

        // ===== 最終 Stage：取 SCr、UO 最大值，再考慮 RRT =====
        let finalStage = Math.max(scrStage, uoStage);

        if (isRRT) {
            finalStage = 3;
            reasons.push('<strong>RRT：</strong>已啟動腎臟替代治療，至少年為 Stage 3。');
        }

        // ===== 顯示結果 =====
        resultDiv.style.display = 'block';

        if (finalStage === 0) {
            badge.className = 'stage-badge bg-green';
            badge.innerText = 'No AKI';
            resultText.innerText = '未達 KDIGO AKI 定義標準。';
            adviceText.innerText = '建議持續監測腎功能與尿量，如臨床有疑慮仍應追蹤。';
        } else {
            if (finalStage === 1) badge.className = 'stage-badge bg-yellow';
            if (finalStage === 2) badge.className = 'stage-badge bg-orange';
            if (finalStage === 3) badge.className = 'stage-badge bg-red';

            badge.innerText = `AKI Stage ${finalStage}`;
            resultText.innerText = '根據 KDIGO 準則判定為 AKI，請配合臨床狀況評估。';

            if (finalStage === 1) {
                adviceText.innerText = '建議評估脫水/低血容與腎毒性藥物，並密切追蹤 SCr 與尿量。';
            } else if (finalStage === 2) {
                adviceText.innerText = '建議檢視液體與血壓狀態、調整腎毒性藥物與劑量，並考慮腎臟科會診。';
            } else if (finalStage === 3) {
                adviceText.innerText = '建議儘速通知主治醫師/腎臟科，評估急性腎損傷嚴重度與 RRT 需求。';
            }
        }

        reasonText.innerHTML = reasons.join('<br>');

        if (!hasAnyUOInput) {
            noteText.innerText = '提醒：本次計算未納入尿量，僅依 SCr 變化判讀 AKI。';
        } else if (!usedUO) {
            noteText.innerText = '';
        }
    }
</script>

</body>
</html>
